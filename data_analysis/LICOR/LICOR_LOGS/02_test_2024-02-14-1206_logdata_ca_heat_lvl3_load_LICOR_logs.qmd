---
title: "LICOR Data Processing"
author: "Bryan Blue"
e-mail: 'bryanblue@arizona.edu'
date: "Last Generated: `r Sys.Date()`"
execute:
  echo: false
format: 
  html:
    code-fold: true
    fig-width: 8
    fig-height: 6
  pdf:
    fig-width: 7
    fig-height: 5
---

```{r setup, include=FALSE}
#| echo: false
knitr::opts_chunk$set(echo = TRUE)
require(tidyverse)
library(dplyr)
library(lubridate)
require(tidyr)
library(ggplot2)
library(here)

# start in the current project directory
# this ensures relative paths will work
# independent of the location the script is run
here::here()
# https://www.regextester.com/ for regex checking
```

## 01_load_LICOR_logs  
__All files (read or written) are assumed to be in UTF-8 and not ASCII. The units row contains special characters that will not render unless this is true. If these values do not render correctly in your software, see if there is an option to use UTF-8 or convert them to values you are able to use.__   
Currently loads one text log from a LICOR data set. It reads each chunk of data that contains a line with "[Header]".  
All lines are skipped unless a remarks row is found. This continues until a line with "[Data]" is found.  
All data and remarks lines are read and assigned a group number to keep the related records together. This repeats until the end of file every time a "[Header]" line is found..  
The original group names, field names, and units are stored off in separate data frames from the first [Data] chunk.  
There are variable names that are not unique e.g. "time". Therefore the variable names are a concatenation of the group name and the variable name separated by an underscore. e.g. group "SysObs" and variable "time" are converted into a new name of "SysObs_time"    
All data files are written to a UTF-8, CSV type text file.  
__NOTE:__ Files that end in TXT should be imported into Excel using the import data option otherwise the UTF-8 units values do not import correctly.  
If a CSV data file is open directly in Excel, DO NOT "Convert large numbers into scientific notation", it may also ask that there are many 'E' values found, should they be treated as exponent values, do not do this either.

### REMARKS:
Remarks are found in both the [Header] section and [Data] section.  
There may be zero or more remarks present in either section.  
All should be read and concatenated into one comma delimited value for output as they are found.  
This means that the remarks field can change as data records are read and more remarks are found.  
  
Remarks start with time followed by a tab character.  
After the tab there are two possibilities  
1. "Stability Definition" (ignore)  
2. the actual remarks text (concatenate to remarks variable as found)  

__EXAMPLE__  
12:44:30	Stability Definition:	A (GasEx): Slp<0.3 Per=15	gsw (GasEx): Slp<0.05 Per=15	F (FlrLS): Slp<5 Per=15  
12:44:44	tc-shade5


```{r all_dat}
#| echo: true

# given a fully qualified LI-COR data log file name
# process it into data frames of the groups, units, var names, data values
# add in a group number column representing a chunk of [Data], there may be many
# add in a remarks column that appends all remark lines as they are found in
# the [Header] section and within the [Data] section
load_data_chunks <- function(filename) {
  con <- file(filename, "rt")
  print("start")
  
  # init vars
  remarks <- "" # used to contain the list of remarks, if any
  i = 0 # used to specify which group of data is being read
  dataLines <- data.frame(matrix(ncol = 1, nrow = 0))
  colnames(dataLines) <- c("original")
  
  while (length(oneLine <- readLines(con, n = 1, skipNul = TRUE, warn = FALSE)) > 0) {

    # get the remarks in header, add ones in [Data] block later
    if (str_detect(oneLine, regex("^[0-9]{2}:[0-9]{2}:[0-9]{2}\t")) &
        !str_detect(oneLine, regex("^[0-9]{2}:[0-9]{2}:[0-9]{2}\tStability Definition:\t"))) 
    {
      if (remarks == "") {
        remarks <- str_replace(oneLine, "\t", " ")
      } else {
        oneLine <- str_replace(oneLine, "\t", " ")
        remarks <- paste(remarks, oneLine, sep = ", ")
      }
    }
    
    
    # read all the records in the found [Data] block
    if (str_detect(oneLine, regex("\\[Data\\]"))) {
      # print("We found data start")
      
      # sequential numbering for each group of [Data] in the file
      i = i + 1
      groupNumber = paste("group",i, sep = "")
      
      # these three groups appear after [Data] in the file
      dataGroups <- paste("data", "data", readLines(con, n = 1, skipNul = TRUE, warn = FALSE), sep = "\t")
      dataVars   <- paste("group", "remarks", readLines(con, n = 1, skipNul = TRUE, warn = FALSE), sep = "\t")
      dataUnits  <- paste("", "", readLines(con, n = 1, skipNul = TRUE, warn = FALSE), sep = "\t")
      
      # create an empty list to store all of the data records in the found block
      # read lines until it is not longer a data line
      while (length(dataLine <- readLines(con, n = 1, skipNul = TRUE, warn = FALSE)) > 0) {
        # print(dataLine)
        
        # remarks could be here too
        if (str_detect(dataLine, regex("^[0-9]{2}:[0-9]{2}:[0-9]{2}\t")) &
            !str_detect(dataLine, regex("^[0-9]{2}:[0-9]{2}:[0-9]{2}\tStability Definition:\t"))) 
        {
          if (remarks == "") {
            remarks <- str_replace(dataLine, "\t", " ")
          } else {
            dataLine <- str_replace(dataLine, "\t", " ")
            remarks <- paste(remarks, dataLine, sep = ", ")
          }
        }
        
        
        # if (str_detect(dataLine, regex("^[0-9]?\t"))) {
        # lines starts with and integer record number and tab
        if (str_detect(dataLine, regex("^[0-9]?\t")) &
            !str_detect(dataLine, regex("^[0-9]{2}:[0-9]{2}:[0-9]{2}\t"))) {
          finalString <- paste(groupNumber, remarks, dataLine, sep = "\t")
          dataLines[nrow(dataLines) + 1,] = finalString
          # } else {
          #   break
        }
        
        if (str_detect(dataLine, regex("\\[Header\\]"))) {
              remarks <- ""
          # done reading data lines from the current block
          # reset remarks for next group of data
          break
        }
      }
    }

  }
  print("stop")
  close(con)
  
  return(list(dataGroups, dataUnits, dataVars, dataLines))
  
}


# this will not work for multiple files
# TODO add the filename to the data
# TODO add looping to process all files in a folder

#output <- load_data_chunks(here("data_raw/2023-09-22-B2Trf_Joost/2023-09-22-1536_logdata"))
output <- load_data_chunks(here("data_raw/2024-02-14-1206_logdata_ca_heat_lvl3"))


# output contains tabular data broken into the group, units, var names, and values
# break them into their own tables for further use
groupsdf <- data.frame(do.call('rbind',strsplit(as.character(output[[1]]),'\t',fixed=TRUE)))
unitsdf <- data.frame(do.call('rbind',strsplit(as.character(output[[2]]),'\t',fixed=TRUE)))
varsdf <- data.frame(do.call('rbind',strsplit(as.character(output[[3]]),'\t',fixed=TRUE)))
valuesdf <- data.frame(do.call('rbind',strsplit(as.character(output[[4]][,1]),'\t',fixed=TRUE)))

# write out a text file that Excel can read
write_csv(groupsdf, here("data_cleaned/licor_data_cleaned_UTF-8.txt"), append = FALSE, col_names = FALSE)
write_csv(varsdf, here("data_cleaned/licor_data_cleaned_UTF-8.txt"), append = TRUE, col_names = FALSE)
write_csv(unitsdf, here("data_cleaned/licor_data_cleaned_UTF-8.txt"), append = TRUE, col_names = FALSE)
write_csv(valuesdf, here("data_cleaned/licor_data_cleaned_UTF-8.txt"), append = TRUE, col_names = FALSE)

```


```{r select_data}
#| echo: true

# variable names are not unique, prepend the group to fix it
new_field_list <- paste(groupsdf[1,], varsdf[1,], sep = "_")
colnames(valuesdf) <- new_field_list #varsdf[1,]

# set the proper variable types
# LI-COR data has values that are not consistent in number of sig digits
#        inconsistent such as seconds appear as partial and full seconds in the same column
# TODO this function needs to be implemented
# faluesdf <- assign_field_types(valuesdf)


# TODO create a fix types function
sigdif = 8    # default number of digits for data readings
valuesdf$SysObs_date <-     as.POSIXct(valuesdf$SysObs_date, format = "%Y%m%d %H:%M:%S")
valuesdf$SysObs_obs <-      as.numeric(valuesdf$SysObs_obs)
valuesdf$SysObs_time <-     round(as.numeric(valuesdf$SysObs_time))
valuesdf$SysObs_elapsed <-  round(as.numeric(valuesdf$SysObs_elapsed),digits = 0)
valuesdf$GasEx_gsw <-   round(as.numeric(valuesdf$GasEx_gsw), digits = sigdif)
valuesdf$GasEx_TIME <-  round(as.numeric(valuesdf$GasEx_TIME))
valuesdf$GasEx_E <-     round(as.numeric(valuesdf$GasEx_E),digits = sigdif)
valuesdf$GasEx_Emm <-   round(as.numeric(valuesdf$GasEx_Emm),digits = sigdif)
valuesdf$GasEx_A <-     round(as.numeric(valuesdf$GasEx_A),digits = sigdif)
valuesdf$GasEx_Ca <-    round(as.numeric(valuesdf$GasEx_Ca),digits = sigdif)
valuesdf$GasEx_VPDleaf <-    round(as.numeric(valuesdf$GasEx_VPDleaf), digits = sigdif)
valuesdf$`FLR_Fv'/Fm'` <-    round(as.numeric(valuesdf$`FLR_Fv'/Fm'`),digits = sigdif)


# load the names of the columns of interest
# UTF-8 CSV text file to keep units in proper form
select_field_list <- read_csv(here("data_raw/select_logdata_fields.csv"), 
                       col_names = FALSE, 
                       n_max = 2,
                       show_col_types = FALSE) 

# Append new column to front of data, 'group' is required as column 1, 'remarks' as column 2
# there is a better way to do this
sysdf <- data.frame(matrix(ncol = 2, nrow = 2))
sysdf[1,1] <- groupsdf[1]
sysdf[1,2] <- groupsdf[1]
sysdf[2,1] <- varsdf[1]
sysdf[2,2] <- varsdf[2]
select_field_list <- data.frame(sysdf, select_field_list)
rm(sysdf)

# variable names are not unique, add suffix of the group to fix it
new_select_field_list <- paste(select_field_list[1,], select_field_list[2,], sep = "_")
colnames(unitsdf) <- new_field_list

# create a set of data that the user specified in select_field_list
final_data <- valuesdf %>% select(any_of(new_select_field_list))

# TODO these should already be done in the fix types routine above
# this is only for test graphing below
final_data$SysObs_date <- as.POSIXct(final_data$SysObs_date, format = "%Y%m%d %H:%M:%S")
final_data$GasEx_gsw <- as.numeric(final_data$GasEx_gsw)

write_csv(final_data, here("data_cleaned/selected_licor_data.csv"), append = FALSE, col_names = TRUE)

```



```{r test_graph_cont}

ggplot() +
    # geom_point(data = final_data, 
    geom_point(data=subset(final_data, data_group=="group2"), 
               aes(x = SysObs_date, y = GasEx_gsw, color = "GasEx_gsw")) +
    # geom_line(data = final_data, aes(x = SysObs_date, y = GasEx_gsw, color = "GasEx_gsw")) +
    # geom_line(data = final_data, aes(x = date, y = temperature, color = sensor_id)) +
    # geom_line(data = final_data, aes(x = date, y = temperature, color = sensor_id)) +
    ggtitle("LICOR Test Graph - GasEx gsw CONTROL LEAF") +
    xlab("SysObs_date") +
    ylab("GasEx_gsw") +
    scale_y_continuous(limits=c(0.0, 0.2), breaks=c(0, 0.1, 0.2, 0.5)) +
    scale_x_datetime(date_labels = ("%M:%S"),
        date_breaks = "10 sec",  expand = expansion(0)) +
    theme(axis.text.x=element_text(angle=60, hjust=1))
    # 
  
      # scale_x_datetime(labels=date_format("%b %y"))
    #   date_breaks = "6 hours",  expand = expansion(0)) +
    
    # theme(axis.text.x=element_text(angle=60, hjust=1))



```
```{r test_graph_trt}
ggplot() +
    # geom_point(data = final_data, 
    geom_point(data=subset(final_data, data_group=="group3"), 
               aes(x = SysObs_date, y = GasEx_gsw, color = "GasEx_gsw")) +
    # geom_line(data = final_data, aes(x = SysObs_date, y = GasEx_gsw, color = "GasEx_gsw")) +
    # geom_line(data = final_data, aes(x = date, y = temperature, color = sensor_id)) +
    # geom_line(data = final_data, aes(x = date, y = temperature, color = sensor_id)) +
    # geom_line(data = final_data, aes(x = date, y = temperature, color = sensor_id)) +
    # geom_line(data = final_data, aes(x = date, y = TEMP_THREE_FOOT_HEIGHT, color = "CEAC")) +
    ggtitle("LICOR Test Graph - GasEx gsw - TREATMENT LEAF") +
    xlab("SysObs_date") +
    ylab("GasEx_gsw") +
    scale_y_continuous(limits=c(0.0, 0.2), breaks=c(0, 0.1, 0.2, 0.5)) +
    scale_x_datetime(date_labels = ("%M:%S"),
        date_breaks = "10 sec",  expand = expansion(0)) +
    theme(axis.text.x=element_text(angle=60, hjust=1))
    # 
  
      # scale_x_datetime(labels=date_format("%b %y"))
    #   date_breaks = "6 hours",  expand = expansion(0)) +
    
    # theme(axis.text.x=element_text(angle=60, hjust=1))

final_data['data_remarks'][final_data['data_remarks'] == '12:21:19 lvl3 ref'] <- 'Reference'
final_data['data_remarks'][final_data['data_remarks'] == '12:07:55 lvl3 ctrl'] <- 'Control'
final_data['data_remarks'][final_data['data_remarks'] == '12:30:05 lvl3 trt'] <- 'Treatment'
# 11:34:16 lvl2_trt

ggplot(final_data, aes(x = data_remarks , y = GasEx_gsw, color = data_remarks)) + 
  geom_boxplot(outlier.colour="red",
                outlier.size=4) +
  ggtitle("LICOR GasEx gsw - 2024-02-14-1206_logdata_ca_heat_lvl3") +
    xlab("Leaf") +
    ylab("GasEx_gsw") 

ggplot(final_data, aes(x = data_remarks , y = GasEx_A, color = data_remarks)) + 
  geom_boxplot(outlier.colour="red",
                outlier.size=4) +
  ggtitle("LICOR GasEx A - 2024-02-14-1206_logdata_ca_heat_lvl3") +
    xlab("Leaf") +
    ylab("GasEx_A") 

ggplot(final_data, aes(x = data_remarks , y = Meas_Tleaf, color = data_remarks)) + 
  geom_boxplot(outlier.colour="red",
                outlier.size=4) +
  ggtitle("LICOR Meas Tleaf - 2024-02-14-1206_logdata_ca_heat_lvl3") +
    xlab("Leaf") +
    ylab("Meas_Tleaf") 

ggplot(final_data, aes(x = data_remarks , y = GasEx_VPDleaf, color = data_remarks)) + 
  geom_boxplot(outlier.colour="red",
                outlier.size=4) +
  ggtitle("LICOR GasEx VPDleaf - 2024-02-14-1206_logdata_ca_heat_lvl3") +
    xlab("Leaf") +
    ylab("GasEx_VPDleaf") 

ggplot(final_data, aes(x = data_remarks , y = `FLR_Fv'/Fm'`, color = data_remarks)) + 
  geom_boxplot(outlier.colour="red",
                outlier.size=4) +
  ggtitle("LICOR `FLR Fv'/Fm'` - 2024-02-14-1206_logdata_ca_heat_lvl3") +
    xlab("Leaf") +
    ylab("FLR_Fv'/Fm'") 

ggplot(final_data, aes(x = data_remarks , y = "GasEx_A", color = data_remarks)) + 
  geom_boxplot(outlier.colour="red",
                outlier.size=4) +
  ggtitle("LICOR GasEx_A - 2024-02-14-1206_logdata_ca_heat_lvl3") +
    xlab("Leaf") +
    ylab("GasEx_A") 

# ggplot(final_data, aes(x=dose, y=len)) +
#   geom_boxplot(outlier.colour="red", outlier.shape=8,
#                 outlier.size=4)

```

```{r test_graph_ref}
ggplot() +
    # geom_point(data = final_data, 
    geom_point(data=subset(final_data, data_group=="group1"), 
               aes(x = SysObs_date, y = GasEx_gsw, color = "GasEx_gsw")) +
    # geom_line(data = final_data, aes(x = SysObs_date, y = GasEx_gsw, color = "GasEx_gsw")) +
    # geom_line(data = final_data, aes(x = date, y = temperature, color = sensor_id)) +
    # geom_line(data = final_data, aes(x = date, y = temperature, color = sensor_id)) +
    # geom_line(data = final_data, aes(x = date, y = temperature, color = sensor_id)) +
    # geom_line(data = final_data, aes(x = date, y = TEMP_THREE_FOOT_HEIGHT, color = "CEAC")) +
    ggtitle("LICOR Test Graph - GasEx gsw - REFERENCE LEAF") +
    xlab("SysObs_date") +
    ylab("GasEx_gsw") +
    scale_y_continuous(limits=c(0.0, 0.2), breaks=c(0, 0.1, 0.2, 0.5)) +
    scale_x_datetime(date_labels = ("%M:%S"),
        date_breaks = "10 sec",  expand = expansion(0)) +
    theme(axis.text.x=element_text(angle=60, hjust=1))
    # 
  
      # scale_x_datetime(labels=date_format("%b %y"))
    #   date_breaks = "6 hours",  expand = expansion(0)) +
    
    # theme(axis.text.x=element_text(angle=60, hjust=1))



```