---
title: "Wrangle Experimental Datalogger Sensor Data"
author: "Bryan Blue"
format: html

---


```{r init}
#| echo: false
#| warning: false

library(here)
library(readr)
library(purrr)
library(dplyr)
library(lubridate)
library(tidyr)
library(ggplot2)
library(patchwork)

source("DL_experiment_logs_functions.R")

# constants to data paths
DATARAW <- "data_raw"
DATACLEAN <- "data_clean"
DATAUSER <- "data_user"
```

## Load Data Logger Data
Many climate and TRC data logs exist. Read them all into a "raw_" df  
Run unique on each df due to an SD card not erased before being reused.  
Break each log into the individual sensors values which correspond to the MAC address in the file.  

### Data Issues
Are all of the logs from a valid start dates?  
There are more MAC address than should be here for the actual experiment. These need identified and removed.  
TRC data has duplication of 2 MAC addresses. One in the all capital MAC format, and one in the colon version. These need combined or removed.  
TRC has one line that is NA which needs removed.  

```{r dl_log_loading}
#| echo: false
#| warning: false
#
# read in all climate and TRC data
# run unique as there is overlap when an SD card was not erased before reuse
raw_climate_dl_data <- read_climate_log_data()

raw_TRC_dl_data <- read_TRC_log_data()

# remove seconds from date/time fields, only precision to minutes
raw_climate_dl_data$sensor_datetime <- format(as.POSIXct(raw_climate_dl_data$sensor_datetime), "%d-%m-%Y %H:%M")
raw_climate_dl_data$DL_datetime <- format(as.POSIXct(raw_climate_dl_data$DL_datetime), "%d-%m-%Y %H:%M")
raw_climate_dl_data$sensor_datetime <- as.POSIXct(raw_climate_dl_data$sensor_datetime)
raw_climate_dl_data$DL_datetime <- as.POSIXct(raw_climate_dl_data$DL_datetime)


raw_TRC_dl_data$sensor_datetime <- as.POSIXct(format(as.POSIXct(raw_TRC_dl_data$sensor_datetime), "%d-%m-%Y %H:%M"))
raw_TRC_dl_data$DL_datetime <- as.POSIXct(raw_TRC_dl_data$DL_datetime), "%d-%m-%Y %H:%M")

climate_dl_data <- raw_climate_dl_data %>% distinct(DL_datetime, sensor_datetime, sensor_MAC, .keep_all=TRUE)
TRC_dl_data <- raw_TRC_dl_data %>% distinct(DL_datetime, sensor_datetime, sensor_MAC, .keep_all=TRUE)

# list out the unique MAC addresses found in all the logs
unique(raw_climate_dl_data$sensor_MAC)

climate_dl_data_48E72953672E <- climate_dl_data %>% dplyr::filter(sensor_MAC == "48E72953672E") 
climate_dl_data_485519DF2848 <- climate_dl_data %>% dplyr::filter(sensor_MAC == "485519DF2848") 
climate_dl_data_48E72952E8D2 <- climate_dl_data %>% dplyr::filter(sensor_MAC == "48E72952E8D2") 

# list out the unique MAC addresses found in all the logs
unique(raw_TRC_dl_data$sensor_MAC)

TRC_dl_data_48E729537E2C <- TRC_dl_data %>% dplyr::filter(sensor_MAC == "48E729537E2C") 
TRC_dl_data_48E7295552AD <- TRC_dl_data %>% dplyr::filter(sensor_MAC == "48E7295552AD") 
TRC_dl_data_48E72953672E <- TRC_dl_data %>% dplyr::filter(sensor_MAC == "48E72953672E") 
TRC_dl_data_48E7295348F8 <- TRC_dl_data %>% dplyr::filter(sensor_MAC == "48E7295348F8") 
# These colon version of the MAC address also appear as the all capital version above
# TODO why did this happen? It is a software version difference.
# TODO only 3 MAC addresses are valid, the fourth would be testing
TRC_dl_data_48E7295348F8_2 <- TRC_dl_data %>% dplyr::filter(sensor_MAC == "48:e7:29:53:48:f8") 
TRC_dl_data_48E7295552AD_2 <- TRC_dl_data %>% dplyr::filter(sensor_MAC == "48:e7:29:55:52:ad") 


```

## Log Cleanup  
Remove seconds, only need minutes  

```{r test_graphs}
s <- raw_climate_dl_data %>% filter(DL_datetime >= as.POSIXct("2024-03-01 00:00:00") & 
                                      DL_datetime <= as.POSIXct("2024-04-01 00:00:00") &
                                      sensor_MAC == "48E72953672E")

plotT <- ggplot() +
  # geom_point(data = final_data, 
  geom_line(data=s, 
            aes(x = DL_datetime, y = temp_C, color = sensor_MAC)) +
  # geom_line(data = final_data, aes(x = SysObs_date, y = GasEx_gsw, color = "GasEx_gsw")) +
  ggtitle("Temperatures By MAC") +
  xlab("Day of Month") +
  ylab("Temperature (C)") +
  # scale_color_manual(name='MAC',
  #                    breaks=c('Treatment', 'Control', 'Reference'),
  #                    values=c('Treatment'='#F8766D', 'Control'='#619CFF', 'Reference'='#00BA38'))+
  # scale_y_continuous(limits=c(0.0, 0.2), breaks=c(0, 0.1, 0.2, 0.5))   +
  scale_x_datetime(date_labels = ("%d"),
      date_breaks = "days",  expand = expansion(0)) +
  theme(axis.text.x=element_text(angle=60, hjust=1))
plotT

plotRH <- ggplot() +
  # geom_point(data = final_data, 
  geom_line(data=s, 
            aes(x = DL_datetime, y = RH, color = sensor_MAC)) +
  # geom_line(data = final_data, aes(x = SysObs_date, y = GasEx_gsw, color = "GasEx_gsw")) +
  ggtitle("RH By MAC") +
  xlab("Day of Month") +
  ylab("RH (%)") +
  # scale_color_manual(name='MAC',
  #                    breaks=c('Treatment', 'Control', 'Reference'),
  #                    values=c('Treatment'='#F8766D', 'Control'='#619CFF', 'Reference'='#00BA38'))+
  # scale_y_continuous(limits=c(25.0, 100.0))   +
  scale_x_datetime(date_labels = ("%d"),
      date_breaks = "days",  expand = expansion(0)) +
  theme(axis.text.x=element_text(angle=60, hjust=1))
plotRH

plotT/plotRH
```

